#!/usr/bin/env bash
#
# Shadow9 Manager - Initial Setup Script
# This script installs shadow9 system-wide (no virtual environment)
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo -e "${CYAN}"
echo "============================================================"
echo "                 Shadow9 Manager Setup                      "
echo "         Secure SOCKS5 Proxy with Tor Support               "
echo "============================================================"
echo -e "${NC}"

# Make scripts executable
chmod +x "$SCRIPT_DIR/shadow9" 2>/dev/null || true
chmod +x "$SCRIPT_DIR/setup" 2>/dev/null || true

# Function to check if running as root
is_root() {
    [ "$EUID" -eq 0 ] || [ "$(id -u)" -eq 0 ]
}

# Function to run commands with sudo if needed
run_privileged() {
    if is_root; then
        "$@"
    else
        sudo "$@"
    fi
}

# Function to detect OS and install system dependencies
install_system_deps() {
    echo -e "${CYAN}[1/5]${NC} Installing system dependencies..."
    
    # Detect OS
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        OS_LIKE=$ID_LIKE
    elif [ -f /etc/debian_version ]; then
        OS="debian"
    elif [ -f /etc/redhat-release ]; then
        OS="rhel"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        OS="macos"
    else
        OS="unknown"
    fi
    
    case "$OS" in
        ubuntu|debian|linuxmint|pop)
            echo -e "${CYAN}Detected Debian/Ubuntu-based system${NC}"
            run_privileged apt-get update -qq
            run_privileged apt-get install -y -qq python3 python3-pip python3-dev curl 2>/dev/null
            echo -e "${GREEN}[OK] System packages installed${NC}"
            ;;
        fedora)
            echo -e "${CYAN}Detected Fedora${NC}"
            run_privileged dnf install -y -q python3 python3-pip python3-devel curl 2>/dev/null
            echo -e "${GREEN}[OK] System packages installed${NC}"
            ;;
        centos|rhel|rocky|almalinux)
            echo -e "${CYAN}Detected RHEL-based system${NC}"
            run_privileged yum install -y -q python3 python3-pip python3-devel curl 2>/dev/null
            echo -e "${GREEN}[OK] System packages installed${NC}"
            ;;
        arch|manjaro)
            echo -e "${CYAN}Detected Arch-based system${NC}"
            run_privileged pacman -Sy --noconfirm --quiet python python-pip curl 2>/dev/null
            echo -e "${GREEN}[OK] System packages installed${NC}"
            ;;
        alpine)
            echo -e "${CYAN}Detected Alpine Linux${NC}"
            run_privileged apk add --quiet python3 py3-pip python3-dev curl 2>/dev/null
            echo -e "${GREEN}[OK] System packages installed${NC}"
            ;;
        macos)
            echo -e "${CYAN}Detected macOS${NC}"
            if command -v brew &> /dev/null; then
                brew install python3 2>/dev/null || true
                echo -e "${GREEN}[OK] System packages installed${NC}"
            else
                echo -e "${YELLOW}[INFO] Homebrew not found. Please install Python manually.${NC}"
            fi
            ;;
        *)
            # Try to detect based on ID_LIKE
            if [[ "$OS_LIKE" == *"debian"* ]]; then
                run_privileged apt-get update -qq
                run_privileged apt-get install -y -qq python3 python3-pip python3-dev curl 2>/dev/null
                echo -e "${GREEN}[OK] System packages installed${NC}"
            elif [[ "$OS_LIKE" == *"rhel"* ]] || [[ "$OS_LIKE" == *"fedora"* ]]; then
                run_privileged yum install -y -q python3 python3-pip python3-devel curl 2>/dev/null || \
                run_privileged dnf install -y -q python3 python3-pip python3-devel curl 2>/dev/null
                echo -e "${GREEN}[OK] System packages installed${NC}"
            else
                echo -e "${YELLOW}[WARN] Unknown OS: $OS. Skipping system package installation.${NC}"
                echo -e "${YELLOW}       Make sure python3 and pip are installed.${NC}"
            fi
            ;;
    esac
}

# Install system dependencies first
install_system_deps

# Check Python version
echo -e "\n${CYAN}[2/5]${NC} Checking Python version..."
if ! command -v python3 &> /dev/null; then
    if ! command -v python &> /dev/null; then
        echo -e "${RED}[ERROR] Python 3.10+ is required but not found.${NC}"
        echo "Please install Python from https://www.python.org/downloads/"
        exit 1
    fi
    PYTHON_CMD="python"
else
    PYTHON_CMD="python3"
fi

PYTHON_VERSION=$($PYTHON_CMD -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
PYTHON_MAJOR=$($PYTHON_CMD -c 'import sys; print(sys.version_info.major)')
PYTHON_MINOR=$($PYTHON_CMD -c 'import sys; print(sys.version_info.minor)')

if [ "$PYTHON_MAJOR" -lt 3 ] || ([ "$PYTHON_MAJOR" -eq 3 ] && [ "$PYTHON_MINOR" -lt 10 ]); then
    echo -e "${RED}[ERROR] Python 3.10+ is required. Found: $PYTHON_VERSION${NC}"
    exit 1
fi
echo -e "${GREEN}[OK] Python $PYTHON_VERSION found${NC}"

# Install Python dependencies system-wide
echo -e "\n${CYAN}[3/5]${NC} Installing Python dependencies system-wide..."

# Use --break-system-packages for newer pip versions that require it
PIP_ARGS="--break-system-packages"
if ! pip3 install --help 2>&1 | grep -q "break-system-packages"; then
    PIP_ARGS=""
fi

# Uninstall any existing shadow9-manager to avoid conflicts
pip3 uninstall shadow9-manager -y 2>/dev/null || true

# Install shadow9 package in editable mode (this handles both deps and entry points)
echo -e "${CYAN}Installing shadow9 package...${NC}"
if is_root; then
    pip3 install $PIP_ARGS -q -e "$SCRIPT_DIR" 2>/dev/null || \
    pip3 install $PIP_ARGS -e "$SCRIPT_DIR"
else
    # Try user install first, fall back to sudo
    pip3 install $PIP_ARGS --user -q -e "$SCRIPT_DIR" 2>/dev/null || \
    sudo pip3 install $PIP_ARGS -q -e "$SCRIPT_DIR" 2>/dev/null || \
    sudo pip3 install $PIP_ARGS -e "$SCRIPT_DIR"
fi
echo -e "${GREEN}[OK] Shadow9 package installed${NC}"

# Create config directory if needed
mkdir -p config

# Generate master key
echo -e "\n${CYAN}[4/5]${NC} Checking encryption key..."

GENERATE_NEW_KEY=false

if [ -f ".env" ] && grep -q "SHADOW9_MASTER_KEY" .env 2>/dev/null; then
    # Key exists, ask if user wants to regenerate
    echo -e "${YELLOW}[INFO] Existing master key found in .env${NC}"
    echo -e "${RED}WARNING: Regenerating the key will make existing credentials unreadable!${NC}"
    read -p "Would you like to generate a new master key? (y/n): " REGEN_KEY
    if [[ "$REGEN_KEY" =~ ^[Yy]$ ]]; then
        GENERATE_NEW_KEY=true
        # Backup old .env
        cp .env .env.backup 2>/dev/null
        echo -e "${YELLOW}[INFO] Old .env backed up to .env.backup${NC}"
        
        # Remove old credentials file (encrypted with old key)
        if [ -f "config/credentials.enc" ]; then
            cp config/credentials.enc config/credentials.enc.backup 2>/dev/null
            rm -f config/credentials.enc
            echo -e "${YELLOW}[INFO] Old credentials removed (backup: config/credentials.enc.backup)${NC}"
            echo -e "${YELLOW}[INFO] You will need to create new users after setup${NC}"
        fi
    else
        # Load existing key
        source .env
        MASTER_KEY="$SHADOW9_MASTER_KEY"
        echo -e "${GREEN}[OK] Using existing master key${NC}"
    fi
else
    GENERATE_NEW_KEY=true
fi

if [ "$GENERATE_NEW_KEY" = true ]; then
    # Generate new key
    MASTER_KEY=$($PYTHON_CMD -c "import secrets; print(secrets.token_urlsafe(32))")

    # Save to .env file
    cat > .env << EOF
# Shadow9 Master Key - Keep this secret!
# This key encrypts your credentials file
SHADOW9_MASTER_KEY=$MASTER_KEY
EOF
    chmod 600 .env

    echo -e "${GREEN}[OK] Master key generated and saved to .env${NC}"
fi

# Verify shadow9 command is available
echo -e "\n${CYAN}[5/5]${NC} Verifying shadow9 command..."

# Check if shadow9 is in PATH
if command -v shadow9 &> /dev/null; then
    SHADOW9_PATH=$(command -v shadow9)
    echo -e "${GREEN}[OK] shadow9 command available at: $SHADOW9_PATH${NC}"
else
    # Pip might have installed to a location not in PATH, create symlink as fallback
    echo -e "${YELLOW}[INFO] shadow9 not found in PATH, creating symlink...${NC}"
    
    if is_root; then
        INSTALL_DIR="/usr/local/bin"
    elif [ -d "$HOME/.local/bin" ]; then
        INSTALL_DIR="$HOME/.local/bin"
    else
        mkdir -p "$HOME/.local/bin"
        INSTALL_DIR="$HOME/.local/bin"
    fi
    
    # Create symlink to the project script
    ln -sf "$SCRIPT_DIR/shadow9" "$INSTALL_DIR/shadow9"
    echo -e "${GREEN}[OK] Linked to $INSTALL_DIR/shadow9${NC}"
    
    # Check if install dir is in PATH
    if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
        echo -e "${YELLOW}[INFO] Add this to your shell config:${NC}"
        echo -e "  export PATH=\"$INSTALL_DIR:\$PATH\""
        
        # Try to add to shell config
        for RC_FILE in "$HOME/.bashrc" "$HOME/.zshrc"; do
            if [ -f "$RC_FILE" ]; then
                if ! grep -q "$INSTALL_DIR" "$RC_FILE" 2>/dev/null; then
                    echo "" >> "$RC_FILE"
                    echo "# Added by shadow9 setup" >> "$RC_FILE"
                    echo "export PATH=\"$INSTALL_DIR:\$PATH\"" >> "$RC_FILE"
                    echo -e "${GREEN}[OK] Added to $(basename $RC_FILE)${NC}"
                fi
            fi
        done
    fi
fi

echo -e "${GREEN}"
echo "============================================================"
echo "                    Setup Complete!                         "
echo "------------------------------------------------------------"
echo "  1. Create a user:                                         "
echo "     shadow9 user generate                                  "
echo "                                                            "
echo "  2. Start the server:                                      "
echo "     shadow9 serve                                          "
echo "                                                            "
echo "  3. Connect your app (SOCKS5 proxy):                       "
echo "     Host: 0.0.0.0    Port: 1080                            "
echo "                                                            "
echo "  For more options: shadow9 --help                          "
echo "============================================================"
echo -e "${NC}"



# Ask if user wants to run shadow9 setup
echo ""
read -p "Would you like to run shadow9 setup to install Tor and bridges? (y/n): " RUNSETUP
if [[ "$RUNSETUP" =~ ^[Yy]$ ]]; then
    echo ""
    echo -e "${CYAN}Running shadow9 setup...${NC}"
    echo ""
    "$SCRIPT_DIR/shadow9" setup
fi

#!/usr/bin/env bash
#
# Shadow9 Manager - Initial Setup Script
# This script sets up the environment and creates the first user
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo -e "${CYAN}"
echo "============================================================"
echo "                 Shadow9 Manager Setup                      "
echo "         Secure SOCKS5 Proxy with Tor Support               "
echo "============================================================"
echo -e "${NC}"

# Make scripts executable
chmod +x "$SCRIPT_DIR/shadow9" 2>/dev/null || true
chmod +x "$SCRIPT_DIR/setup" 2>/dev/null || true

# Check Python version
echo -e "${CYAN}[1/6]${NC} Checking Python version..."
if ! command -v python3 &> /dev/null; then
    if ! command -v python &> /dev/null; then
        echo -e "${RED}[ERROR] Python 3.10+ is required but not found.${NC}"
        echo "Please install Python from https://www.python.org/downloads/"
        exit 1
    fi
    PYTHON_CMD="python"
else
    PYTHON_CMD="python3"
fi

PYTHON_VERSION=$($PYTHON_CMD -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
PYTHON_MAJOR=$($PYTHON_CMD -c 'import sys; print(sys.version_info.major)')
PYTHON_MINOR=$($PYTHON_CMD -c 'import sys; print(sys.version_info.minor)')

if [ "$PYTHON_MAJOR" -lt 3 ] || ([ "$PYTHON_MAJOR" -eq 3 ] && [ "$PYTHON_MINOR" -lt 10 ]); then
    echo -e "${RED}[ERROR] Python 3.10+ is required. Found: $PYTHON_VERSION${NC}"
    exit 1
fi
echo -e "${GREEN}[OK] Python $PYTHON_VERSION found${NC}"

# Create virtual environment
echo -e "\n${CYAN}[2/6]${NC} Setting up virtual environment..."
if [ ! -d "venv" ]; then
    $PYTHON_CMD -m venv venv
    echo -e "${GREEN}[OK] Virtual environment created${NC}"
else
    echo -e "${YELLOW}[INFO] Virtual environment already exists${NC}"
fi

# Activate virtual environment
source venv/bin/activate

# Install dependencies
echo -e "\n${CYAN}[3/6]${NC} Installing dependencies..."
pip install --upgrade pip -q
pip install -e . -q
echo -e "${GREEN}[OK] Dependencies installed${NC}"

# Create config directory if needed
mkdir -p config

# Generate master key (only if not exists)
echo -e "\n${CYAN}[4/6]${NC} Checking encryption key..."

if [ -f ".env" ] && grep -q "SHADOW9_MASTER_KEY" .env 2>/dev/null; then
    # Load existing key
    source .env
    MASTER_KEY="$SHADOW9_MASTER_KEY"
    echo -e "${YELLOW}[INFO] Using existing master key from .env${NC}"
else
    # Generate new key
    MASTER_KEY=$(python -c "import secrets; print(secrets.token_urlsafe(32))")

    # Save to .env file
    cat > .env << EOF
# Shadow9 Master Key - Keep this secret!
# This key encrypts your credentials file
SHADOW9_MASTER_KEY=$MASTER_KEY
EOF
    chmod 600 .env

    echo -e "${GREEN}[OK] Master key generated and saved to .env${NC}"
    echo -e "${YELLOW}[INFO] IMPORTANT: Keep this key safe! You'll need it to access your credentials.${NC}"
fi

# Setup shell completion
echo -e "\n${CYAN}[5/6]${NC} Setting up tab completion..."

# Detect shell and configure completion
COMPLETION_INSTALLED=false

# Create completion script that works with both 'shadow9' and './shadow9'
COMPLETION_SCRIPT="$SCRIPT_DIR/.shadow9-completion.bash"
cat > "$COMPLETION_SCRIPT" << COMPLETION_EOF
# Shadow9 tab completion
_shadow9_completion() {
    local IFS=\$'\n'
    local shadow9_cmd="$SCRIPT_DIR/venv/bin/shadow9"

    if [ -x "\$shadow9_cmd" ]; then
        COMPREPLY=( \$( env COMP_WORDS="\${COMP_WORDS[*]}" \\
                       COMP_CWORD=\$COMP_CWORD \\
                       _SHADOW9_COMPLETE=bash_complete "\$shadow9_cmd" ) )
    fi
    return 0
}

# Register completion for both 'shadow9' and './shadow9'
complete -o default -F _shadow9_completion shadow9
complete -o default -F _shadow9_completion ./shadow9
COMPLETION_EOF

COMPLETION_CMD="source \"$SCRIPT_DIR/.shadow9-completion.bash\""

# Try to add to bashrc
if [ -f "$HOME/.bashrc" ]; then
    if ! grep -q ".shadow9-completion.bash" "$HOME/.bashrc" 2>/dev/null; then
        # Remove old completion if present
        sed -i '/_SHADOW9_COMPLETE/d' "$HOME/.bashrc" 2>/dev/null || true
        sed -i '/Shadow9 tab completion/d' "$HOME/.bashrc" 2>/dev/null || true
        echo "" >> "$HOME/.bashrc"
        echo "# Shadow9 tab completion" >> "$HOME/.bashrc"
        echo "$COMPLETION_CMD" >> "$HOME/.bashrc"
        COMPLETION_INSTALLED=true
        echo -e "${GREEN}[OK] Tab completion added to ~/.bashrc${NC}"
    else
        echo -e "${YELLOW}[INFO] Tab completion already configured in ~/.bashrc${NC}"
        COMPLETION_INSTALLED=true
    fi
fi

# Try to add to zshrc if zsh is present
if [ -f "$HOME/.zshrc" ]; then
    # Create zsh completion script
    ZSH_COMPLETION_SCRIPT="$SCRIPT_DIR/.shadow9-completion.zsh"
    cat > "$ZSH_COMPLETION_SCRIPT" << ZSH_COMPLETION_EOF
# Shadow9 tab completion for zsh
_shadow9_completion() {
    local -a completions
    local -a completions_with_descriptions
    local -a response
    local shadow9_cmd="$SCRIPT_DIR/venv/bin/shadow9"

    [[ ! -x "\$shadow9_cmd" ]] && return 1

    response=("\${(@f)\$(env COMP_WORDS="\${words[*]}" COMP_CWORD=\$((CURRENT-1)) _SHADOW9_COMPLETE=zsh_complete "\$shadow9_cmd")}")

    for key descr in \${(kv)response}; do
        if [[ "\$descr" == "_" ]]; then
            completions+=("\$key")
        else
            completions_with_descriptions+=("\$key":"\$descr")
        fi
    done

    if [ -n "\$completions_with_descriptions" ]; then
        _describe -V unsorted completions_with_descriptions -U
    fi

    if [ -n "\$completions" ]; then
        compadd -U -V unsorted -a completions
    fi
}

compdef _shadow9_completion shadow9
compdef _shadow9_completion ./shadow9
ZSH_COMPLETION_EOF

    ZSH_COMPLETION_CMD="source \"$SCRIPT_DIR/.shadow9-completion.zsh\""
    if ! grep -q ".shadow9-completion.zsh" "$HOME/.zshrc" 2>/dev/null; then
        # Remove old completion if present
        sed -i '/_SHADOW9_COMPLETE/d' "$HOME/.zshrc" 2>/dev/null || true
        sed -i '/Shadow9 tab completion/d' "$HOME/.zshrc" 2>/dev/null || true
        echo "" >> "$HOME/.zshrc"
        echo "# Shadow9 tab completion" >> "$HOME/.zshrc"
        echo "$ZSH_COMPLETION_CMD" >> "$HOME/.zshrc"
        COMPLETION_INSTALLED=true
        echo -e "${GREEN}[OK] Tab completion added to ~/.zshrc${NC}"
    else
        echo -e "${YELLOW}[INFO] Tab completion already configured in ~/.zshrc${NC}"
        COMPLETION_INSTALLED=true
    fi
fi

if [ "$COMPLETION_INSTALLED" = false ]; then
    echo -e "${YELLOW}[INFO] Could not auto-configure completion.${NC}"
    echo -e "  Add to your shell config: source \"$COMPLETION_SCRIPT\""
fi

# Create first user (only if no users exist)
echo -e "\n${CYAN}[6/6]${NC} Checking users..."
echo ""

# Export the master key for the Python process
export SHADOW9_MASTER_KEY="$MASTER_KEY"

# Run user creation
python -c "
import os
import sys
sys.path.insert(0, 'src')

from pathlib import Path
from shadow9.auth import AuthManager

creds_file = Path('config/credentials.enc')

try:
    # Initialize auth manager with master key
    auth = AuthManager(
        credentials_file=creds_file,
        master_key=os.environ.get('SHADOW9_MASTER_KEY')
    )

    # Check if users already exist
    existing_users = auth.list_users()
    if existing_users:
        print(f\"[INFO] Found {len(existing_users)} existing user(s): {', '.join(existing_users)}\")
        print('[INFO] Skipping user creation. Use ./shadow9 user add <username> to add more.')
    else:
        # Generate secure credentials
        username, password = auth.generate_credentials()
        auth.add_user(username, password, use_tor=True)
        print(f'''
============================================================
                    Your Credentials
------------------------------------------------------------
  Username: {username}
  Password: {password}
------------------------------------------------------------
  [!] SAVE THESE NOW! They will not be shown again.
============================================================
''')

except Exception as e:
    if 'InvalidToken' in str(type(e).__name__) or 'InvalidToken' in str(e) or creds_file.exists():
        print('[WARN] Credentials file is corrupted or key mismatch.')
        print('[>] Removing corrupted credentials and creating fresh...')
        if creds_file.exists():
            creds_file.unlink()

        # Reinitialize and create user
        auth = AuthManager(
            credentials_file=creds_file,
            master_key=os.environ.get('SHADOW9_MASTER_KEY')
        )
        username, password = auth.generate_credentials()
        auth.add_user(username, password, use_tor=True)
        print(f'''
============================================================
                    Your Credentials
------------------------------------------------------------
  Username: {username}
  Password: {password}
------------------------------------------------------------
  [!] SAVE THESE NOW! They will not be shown again.
============================================================
''')
    else:
        raise
"

# Reload shell config to enable completion immediately
if [ -f "$HOME/.bashrc" ]; then
    source "$HOME/.bashrc" 2>/dev/null || true
fi

echo -e "${GREEN}"
echo "============================================================"
echo "                    Setup Complete!                         "
echo "------------------------------------------------------------"
echo "  Start the server:                                         "
echo "     ./shadow9 serve                                        "
echo "                                                            "
echo "  Configure your app to use SOCKS5 proxy:                   "
echo "     Host: 127.0.0.1                                        "
echo "     Port: 1080                                             "
echo "     Auth: Use the credentials above                        "
echo "                                                            "
echo "  Tab completion is enabled. Try:                           "
echo "     ./shadow9 [TAB][TAB]                                   "
echo "                                                            "
echo "  For more options:                                         "
echo "     ./shadow9 --help                                       "
echo "============================================================"
echo -e "${NC}"

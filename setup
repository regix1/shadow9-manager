#!/usr/bin/env bash
#
# Shadow9 Manager - Initial Setup Script
# This script sets up the environment and installs shadow9 globally
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo -e "${CYAN}"
echo "============================================================"
echo "                 Shadow9 Manager Setup                      "
echo "         Secure SOCKS5 Proxy with Tor Support               "
echo "============================================================"
echo -e "${NC}"

# Make scripts executable
chmod +x "$SCRIPT_DIR/shadow9" 2>/dev/null || true
chmod +x "$SCRIPT_DIR/setup" 2>/dev/null || true

# Check Python version
echo -e "${CYAN}[1/6]${NC} Checking Python version..."
if ! command -v python3 &> /dev/null; then
    if ! command -v python &> /dev/null; then
        echo -e "${RED}[ERROR] Python 3.10+ is required but not found.${NC}"
        echo "Please install Python from https://www.python.org/downloads/"
        exit 1
    fi
    PYTHON_CMD="python"
else
    PYTHON_CMD="python3"
fi

PYTHON_VERSION=$($PYTHON_CMD -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
PYTHON_MAJOR=$($PYTHON_CMD -c 'import sys; print(sys.version_info.major)')
PYTHON_MINOR=$($PYTHON_CMD -c 'import sys; print(sys.version_info.minor)')

if [ "$PYTHON_MAJOR" -lt 3 ] || ([ "$PYTHON_MAJOR" -eq 3 ] && [ "$PYTHON_MINOR" -lt 10 ]); then
    echo -e "${RED}[ERROR] Python 3.10+ is required. Found: $PYTHON_VERSION${NC}"
    exit 1
fi
echo -e "${GREEN}[OK] Python $PYTHON_VERSION found${NC}"

# Create virtual environment
echo -e "\n${CYAN}[2/6]${NC} Setting up virtual environment..."
if [ ! -d "venv" ]; then
    $PYTHON_CMD -m venv venv
    echo -e "${GREEN}[OK] Virtual environment created${NC}"
else
    echo -e "${YELLOW}[INFO] Virtual environment already exists${NC}"
fi

# Activate virtual environment
source venv/bin/activate

# Install dependencies
echo -e "\n${CYAN}[3/6]${NC} Installing dependencies..."
pip install --upgrade pip -q
pip install -e . -q
echo -e "${GREEN}[OK] Dependencies installed${NC}"

# Create config directory if needed
mkdir -p config

# Generate master key (only if not exists)
echo -e "\n${CYAN}[4/6]${NC} Checking encryption key..."

if [ -f ".env" ] && grep -q "SHADOW9_MASTER_KEY" .env 2>/dev/null; then
    # Load existing key
    source .env
    MASTER_KEY="$SHADOW9_MASTER_KEY"
    echo -e "${YELLOW}[INFO] Using existing master key from .env${NC}"
else
    # Generate new key
    MASTER_KEY=$(python -c "import secrets; print(secrets.token_urlsafe(32))")

    # Save to .env file
    cat > .env << EOF
# Shadow9 Master Key - Keep this secret!
# This key encrypts your credentials file
SHADOW9_MASTER_KEY=$MASTER_KEY
EOF
    chmod 600 .env

    echo -e "${GREEN}[OK] Master key generated and saved to .env${NC}"
    echo -e "${YELLOW}[INFO] IMPORTANT: Keep this key safe!${NC}"
fi

# Install shadow9 globally
echo -e "\n${CYAN}[5/6]${NC} Installing shadow9 command..."

# Determine install location
if [ -d "$HOME/.local/bin" ]; then
    INSTALL_DIR="$HOME/.local/bin"
elif [ -w "/usr/local/bin" ]; then
    INSTALL_DIR="/usr/local/bin"
else
    mkdir -p "$HOME/.local/bin"
    INSTALL_DIR="$HOME/.local/bin"
fi

# Create wrapper script that uses the venv
WRAPPER="$INSTALL_DIR/shadow9"
cat > "$WRAPPER" << EOF
#!/usr/bin/env bash
# Shadow9 - installed from $SCRIPT_DIR
exec "$SCRIPT_DIR/venv/bin/python" "$SCRIPT_DIR/shadow9" "\$@"
EOF
chmod +x "$WRAPPER"

echo -e "${GREEN}[OK] Installed to $WRAPPER${NC}"

# Check if install dir is in PATH
if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
    echo -e "${YELLOW}[INFO] Add this to your shell config:${NC}"
    echo -e "  export PATH=\"$INSTALL_DIR:\$PATH\""
    
    # Try to add to shell config
    for RC_FILE in "$HOME/.bashrc" "$HOME/.zshrc"; do
        if [ -f "$RC_FILE" ]; then
            if ! grep -q "$INSTALL_DIR" "$RC_FILE" 2>/dev/null; then
                echo "" >> "$RC_FILE"
                echo "# Added by shadow9 setup" >> "$RC_FILE"
                echo "export PATH=\"$INSTALL_DIR:\$PATH\"" >> "$RC_FILE"
                echo -e "${GREEN}[OK] Added to $(basename $RC_FILE)${NC}"
            fi
        fi
    done
fi

# Install tab completion
if shadow9 --install-completion 2>/dev/null; then
    echo -e "${GREEN}[OK] Tab completion installed${NC}"
else
    echo -e "${YELLOW}[INFO] Run 'shadow9 --install-completion' after restarting terminal${NC}"
fi

# Create first user (only if no users exist)
echo -e "\n${CYAN}[6/6]${NC} Checking users..."
echo ""

# Export the master key for the Python process
export SHADOW9_MASTER_KEY="$MASTER_KEY"

# Run user creation
python -c "
import os
import sys
sys.path.insert(0, 'src')

from pathlib import Path
from shadow9.auth import AuthManager

creds_file = Path('config/credentials.enc')

try:
    auth = AuthManager(
        credentials_file=creds_file,
        master_key=os.environ.get('SHADOW9_MASTER_KEY')
    )

    existing_users = auth.list_users()
    if existing_users:
        print(f'[INFO] Found {len(existing_users)} existing user(s): {\", \".join(existing_users)}')
        print('[INFO] Skipping user creation. Use: shadow9 user add <username>')
    else:
        username, password = auth.generate_credentials()
        auth.add_user(username, password, use_tor=True)
        print('''
============================================================
                    Your Credentials
------------------------------------------------------------
  Username: ''' + username + '''
  Password: ''' + password + '''
------------------------------------------------------------
  [!] SAVE THESE NOW! They will not be shown again.
============================================================
''')

except Exception as e:
    if 'InvalidToken' in str(type(e).__name__) or 'InvalidToken' in str(e) or creds_file.exists():
        print('[WARN] Credentials file corrupted. Creating fresh...')
        if creds_file.exists():
            creds_file.unlink()

        auth = AuthManager(
            credentials_file=creds_file,
            master_key=os.environ.get('SHADOW9_MASTER_KEY')
        )
        username, password = auth.generate_credentials()
        auth.add_user(username, password, use_tor=True)
        print('''
============================================================
                    Your Credentials
------------------------------------------------------------
  Username: ''' + username + '''
  Password: ''' + password + '''
------------------------------------------------------------
  [!] SAVE THESE NOW! They will not be shown again.
============================================================
''')
    else:
        raise
"

echo -e "${GREEN}"
echo "============================================================"
echo "                    Setup Complete!                         "
echo "------------------------------------------------------------"
echo "  Start the server (from anywhere):                         "
echo "     shadow9 serve                                          "
echo "                                                            "
echo "  Configure your app to use SOCKS5 proxy:                   "
echo "     Host: 127.0.0.1                                        "
echo "     Port: 1080                                             "
echo "     Auth: Use the credentials above                        "
echo "                                                            "
echo "  Tab completion: restart your terminal, then try:          "
echo "     shadow9 [TAB][TAB]                                     "
echo "                                                            "
echo "  For more options:                                         "
echo "     shadow9 --help                                         "
echo "============================================================"
echo -e "${NC}"

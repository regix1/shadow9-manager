#!/usr/bin/env bash
#
# Shadow9 Manager - Quick Setup Script
# Installs shadow9 system-wide
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'
BOLD='\033[1m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Unicode icons
SUCCESS="${GREEN}✓${NC}"
ERROR="${RED}✗${NC}"
WARNING="${YELLOW}⚠${NC}"
ARROW="${CYAN}→${NC}"

# Helper for printing status
print_status() {
    local icon="$1"
    local message="$2"
    echo -e "  ${icon} ${message}"
}

print_header() {
    echo ""
    echo -e "${CYAN}╭──────────────────────────────────────────────────────────────╮${NC}"
    echo -e "${CYAN}│${NC}                                                              ${CYAN}│${NC}"
    echo -e "${CYAN}│${NC}  ${BOLD}${CYAN}Shadow9 Manager Setup${NC}                                       ${CYAN}│${NC}"
    echo -e "${CYAN}│${NC}                                                              ${CYAN}│${NC}"
    echo -e "${CYAN}│${NC}  ${DIM}Setting up Shadow9 SOCKS5 Proxy Manager${NC}                    ${CYAN}│${NC}"
    echo -e "${CYAN}│${NC}  ${DIM}This will install dependencies and configure the system${NC}   ${CYAN}│${NC}"
    echo -e "${CYAN}│${NC}                                                              ${CYAN}│${NC}"
    echo -e "${CYAN}╰──────────────────────────────────────────────────────────────╯${NC}"
    echo ""
}

print_step() {
    local step="$1"
    local total="$2"
    local title="$3"
    echo ""
    echo -e "${BOLD}${CYAN}Step ${step} of ${total}${NC} ────────────────────────────────── ${title}"
}

print_complete() {
    echo ""
    echo -e "${GREEN}╭──────────────────────────────────────────────────────────────╮${NC}"
    echo -e "${GREEN}│${NC}                                                              ${GREEN}│${NC}"
    echo -e "${GREEN}│${NC}  ${BOLD}${GREEN}Setup Complete!${NC}                                             ${GREEN}│${NC}"
    echo -e "${GREEN}│${NC}                                                              ${GREEN}│${NC}"
    echo -e "${GREEN}│${NC}  ${CYAN}shadow9 user generate${NC}    Create user credentials            ${GREEN}│${NC}"
    echo -e "${GREEN}│${NC}  ${CYAN}shadow9 serve${NC}             Start SOCKS5 proxy                ${GREEN}│${NC}"
    echo -e "${GREEN}│${NC}  ${CYAN}shadow9 --help${NC}            View all options                  ${GREEN}│${NC}"
    echo -e "${GREEN}│${NC}                                                              ${GREEN}│${NC}"
    echo -e "${GREEN}╰──────────────────────────────────────────────────────────────╯${NC}"
    echo ""
}

chmod +x "$SCRIPT_DIR/shadow9" "$SCRIPT_DIR/setup" 2>/dev/null || true

# Helper functions
is_root() { [ "$EUID" -eq 0 ] || [ "$(id -u)" -eq 0 ]; }
run_privileged() { if is_root; then "$@"; else sudo "$@"; fi; }

print_header

# Step 1: System dependencies
print_step 1 4 "System Dependencies"

if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
    OS_LIKE=$ID_LIKE
elif [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macos"
else
    OS="unknown"
fi

case "$OS" in
    ubuntu|debian|linuxmint|pop)
        run_privileged apt-get update -qq
        run_privileged apt-get install -y -qq python3 python3-pip curl 2>/dev/null
        ;;
    fedora)
        run_privileged dnf install -y -q python3 python3-pip curl 2>/dev/null
        ;;
    centos|rhel|rocky|almalinux)
        run_privileged yum install -y -q python3 python3-pip curl 2>/dev/null
        ;;
    arch|manjaro)
        run_privileged pacman -Sy --noconfirm --quiet python python-pip curl 2>/dev/null
        ;;
    alpine)
        run_privileged apk add --quiet python3 py3-pip curl 2>/dev/null
        ;;
    macos)
        command -v brew &>/dev/null && brew install python3 2>/dev/null || true
        ;;
    *)
        if [[ "$OS_LIKE" == *"debian"* ]]; then
            run_privileged apt-get update -qq && run_privileged apt-get install -y -qq python3 python3-pip curl 2>/dev/null
        elif [[ "$OS_LIKE" == *"rhel"* ]] || [[ "$OS_LIKE" == *"fedora"* ]]; then
            run_privileged yum install -y -q python3 python3-pip curl 2>/dev/null || \
            run_privileged dnf install -y -q python3 python3-pip curl 2>/dev/null
        else
            print_status "$WARNING" "Unknown OS. Ensure python3 and pip are installed."
        fi
        ;;
esac
print_status "$SUCCESS" "System packages ready"

# Step 2: Python check
print_step 2 4 "Python Check"
PYTHON_CMD="python3"
command -v python3 &>/dev/null || PYTHON_CMD="python"
command -v $PYTHON_CMD &>/dev/null || { print_status "$ERROR" "Python 3.10+ required"; exit 1; }

PYTHON_VER=$($PYTHON_CMD -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
MAJOR=$($PYTHON_CMD -c 'import sys; print(sys.version_info.major)')
MINOR=$($PYTHON_CMD -c 'import sys; print(sys.version_info.minor)')
[ "$MAJOR" -lt 3 ] || ([ "$MAJOR" -eq 3 ] && [ "$MINOR" -lt 10 ]) && { print_status "$ERROR" "Python 3.10+ required (found $PYTHON_VER)"; exit 1; }
print_status "$SUCCESS" "Python $PYTHON_VER detected"

# Step 3: Install shadow9
print_step 3 4 "Installing Shadow9"
PIP_ARGS=""
pip3 install --help 2>&1 | grep -q "break-system-packages" && PIP_ARGS="--break-system-packages"
pip3 uninstall shadow9-manager -y 2>/dev/null || true

if is_root; then
    pip3 install $PIP_ARGS -q -e "$SCRIPT_DIR" 2>/dev/null || pip3 install $PIP_ARGS -e "$SCRIPT_DIR"
else
    pip3 install $PIP_ARGS --user -q -e "$SCRIPT_DIR" 2>/dev/null || \
    sudo pip3 install $PIP_ARGS -q -e "$SCRIPT_DIR" 2>/dev/null || \
    sudo pip3 install $PIP_ARGS -e "$SCRIPT_DIR"
fi
mkdir -p config
print_status "$SUCCESS" "Package installed"

# Step 4: Master key
print_step 4 4 "Encryption Key"
if [ -f ".env" ] && grep -q "SHADOW9_MASTER_KEY" .env 2>/dev/null; then
    print_status "$SUCCESS" "Master key exists"
else
    shadow9 key generate
fi

# Verify
if command -v shadow9 &>/dev/null; then
    print_status "$SUCCESS" "shadow9 command available"
else
    print_status "$ARROW" "Adding shadow9 to PATH..."
    INSTALL_DIR="${HOME}/.local/bin"
    mkdir -p "$INSTALL_DIR"
    ln -sf "$SCRIPT_DIR/shadow9" "$INSTALL_DIR/shadow9"
    [[ ":$PATH:" != *":$INSTALL_DIR:"* ]] && echo "export PATH=\"$INSTALL_DIR:\$PATH\"" >> ~/.bashrc 2>/dev/null || true
fi

print_complete

# Offer to run shadow9 setup for Tor/bridges
echo -n "Run shadow9 setup to install Tor and bridges? (y/n): "
read RUNSETUP </dev/tty
[[ "$RUNSETUP" =~ ^[Yy] ]] && "$SCRIPT_DIR/shadow9" setup

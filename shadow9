#!/usr/bin/env python3
"""
Shadow9 Manager - Main Control Script
Manage users, start server, and test connections

This script handles:
- Loading environment from .env
- Custom 'test' command for connection testing
- Delegating to the Typer CLI for all other commands
"""

import os
import sys
from pathlib import Path

# Get script directory and change to it
SCRIPT_DIR = Path(__file__).parent.resolve()
os.chdir(SCRIPT_DIR)

# Virtual environment is optional - use system Python if venv doesn't exist
venv_dir = SCRIPT_DIR / "venv"
if venv_dir.exists():
    if sys.platform == "win32":
        venv_python = venv_dir / "Scripts" / "python.exe"
    else:
        venv_python = venv_dir / "bin" / "python"

    # Re-exec with venv Python if we're not already using it
    if venv_python.exists() and Path(sys.executable).resolve() != venv_python.resolve():
        os.execv(str(venv_python), [str(venv_python)] + sys.argv)

# Add src to path for development
sys.path.insert(0, str(SCRIPT_DIR / "src"))

# Load environment variables from .env
env_file = SCRIPT_DIR / ".env"
if env_file.exists():
    with open(env_file) as f:
        for line in f:
            line = line.strip()
            if line and not line.startswith('#') and '=' in line:
                key, _, value = line.partition('=')
                os.environ[key.strip()] = value.strip()


# Check if we can use Unicode
def _can_use_unicode():
    """Check if the terminal supports Unicode."""
    try:
        sys.stdout.write('\u2713')
        sys.stdout.write('\b \b')  # Erase the test character
        return True
    except (UnicodeEncodeError, UnicodeError):
        return False

# Set up symbols based on terminal capability
if sys.platform == "win32":
    # Windows often has encoding issues, use ASCII by default
    try:
        # Try to enable UTF-8 mode on Windows
        import codecs
        sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'replace')
        USE_UNICODE = True
    except Exception:
        USE_UNICODE = False
else:
    USE_UNICODE = True

# Define symbols
if USE_UNICODE:
    SYM_CHECK = '\u2713'  # ✓
    SYM_CROSS = '\u2717'  # ✗
    SYM_BOX_TL = '\u2554'  # ╔
    SYM_BOX_TR = '\u2557'  # ╗
    SYM_BOX_BL = '\u255a'  # ╚
    SYM_BOX_BR = '\u255d'  # ╝
    SYM_BOX_H = '\u2550'   # ═
    SYM_BOX_V = '\u2551'   # ║
else:
    SYM_CHECK = '[OK]'
    SYM_CROSS = '[X]'
    SYM_BOX_TL = '+'
    SYM_BOX_TR = '+'
    SYM_BOX_BL = '+'
    SYM_BOX_BR = '+'
    SYM_BOX_H = '='
    SYM_BOX_V = '|'

# Colors
CYAN = '\033[0;36m'
NC = '\033[0m'


def safe_print(text):
    """Print text, falling back to ASCII if Unicode fails."""
    try:
        print(text)
    except UnicodeEncodeError:
        # Replace Unicode with ASCII equivalents
        ascii_text = text.replace('\u2713', '[OK]').replace('\u2717', '[X]')
        ascii_text = ascii_text.replace('\u2554', '+').replace('\u2557', '+')
        ascii_text = ascii_text.replace('\u255a', '+').replace('\u255d', '+')
        ascii_text = ascii_text.replace('\u2550', '=').replace('\u2551', '|')
        print(ascii_text)


def print_box(lines, color=True):
    """Print a box around the given lines."""
    width = 65
    h_line = SYM_BOX_H * (width - 2)
    
    c = CYAN if color else ''
    n = NC if color else ''
    
    safe_print(f"{c}{SYM_BOX_TL}{h_line}{SYM_BOX_TR}{n}")
    for line in lines:
        padded = line.center(width - 2)
        safe_print(f"{c}{SYM_BOX_V}{padded}{SYM_BOX_V}{n}")
    safe_print(f"{c}{SYM_BOX_BL}{h_line}{SYM_BOX_BR}{n}")


def print_banner():
    """Print the Shadow9 banner."""
    print_box([
        "Shadow9 Manager",
        "Secure SOCKS5 Proxy with Tor Support"
    ])
    print()


def run_test(args):
    """Run the connection test command."""
    import asyncio
    import getpass
    
    print_box(["Shadow9 Connection Test"])
    print()
    
    # Parse arguments
    host = "127.0.0.1"
    port = 1080
    username = None
    password = None
    
    i = 0
    while i < len(args):
        if args[i] == "--host" and i + 1 < len(args):
            host = args[i + 1]
            i += 2
        elif args[i] == "--port" and i + 1 < len(args):
            port = int(args[i + 1])
            i += 2
        elif args[i] == "--user" and i + 1 < len(args):
            username = args[i + 1]
            i += 2
        elif args[i] == "--pass" and i + 1 < len(args):
            password = args[i + 1]
            i += 2
        else:
            i += 1
    
    # Prompt for credentials if not provided
    if not username:
        username = input("Username: ")
    if not password:
        password = getpass.getpass("Password: ")
    
    safe_print(f"\n{CYAN}Testing connection to {host}:{port}...{NC}\n")
    
    from shadow9.socks5_client import Socks5Client, ProxyConfig, Socks5ConnectionError, Socks5AuthError
    
    async def test_connection():
        proxy = ProxyConfig(
            host=host,
            port=port,
            username=username,
            password=password,
            timeout=10.0
        )
        
        client = Socks5Client(proxy)
        
        try:
            safe_print('  [1/3] Connecting to proxy...')
            await client.connect('httpbin.org', 80)
            safe_print(f'  {SYM_CHECK} Proxy connection successful')
            
            safe_print('  [2/3] Testing HTTP request...')
            request = b'GET /ip HTTP/1.1\r\nHost: httpbin.org\r\nConnection: close\r\n\r\n'
            await client.send(request)
            
            response = await client.recv(4096)
            safe_print(f'  {SYM_CHECK} HTTP request successful')
            
            safe_print('  [3/3] Parsing response...')
            response_text = response.decode('utf-8', errors='replace')
            
            if 'origin' in response_text:
                import json
                body_start = response_text.find('{')
                if body_start != -1:
                    body = response_text[body_start:]
                    try:
                        data = json.loads(body)
                        safe_print(f'  {SYM_CHECK} Your exit IP: {data.get("origin", "Unknown")}')
                    except Exception:
                        safe_print(f'  {SYM_CHECK} Connection verified (could not parse IP)')
            else:
                safe_print(f'  {SYM_CHECK} Connection verified')
            
            await client.close()
            
            print()
            h_line = SYM_BOX_H * 63
            safe_print(h_line)
            safe_print(f'                    {SYM_CHECK} ALL TESTS PASSED')
            safe_print(h_line)
            return True
            
        except Socks5AuthError as e:
            safe_print(f'  {SYM_CROSS} Authentication failed: {e}')
            print()
            safe_print('  Check your username and password.')
            return False
        except Socks5ConnectionError as e:
            safe_print(f'  {SYM_CROSS} Connection error: {e}')
            return False
        except ConnectionRefusedError:
            safe_print(f'  {SYM_CROSS} Connection refused - is the server running?')
            print()
            safe_print('  Start the server with: ./shadow9 serve')
            return False
        except Exception as e:
            safe_print(f'  {SYM_CROSS} Error: {e}')
            return False
    
    result = asyncio.run(test_connection())
    return 0 if result else 1


def main():
    # Skip everything if this is a completion request
    if "_SHADOW9_COMPLETE" in os.environ:
        from shadow9.cli import cli
        cli()
        return
    
    args = sys.argv[1:]
    
    # Handle custom test command
    if args and args[0] == "test":
        sys.exit(run_test(args[1:]))
    
    # Import and run the Typer CLI
    from shadow9.cli import cli
    
    # Show banner when no command given, then show help
    if not args:
        print_banner()
        sys.argv.append("--help")
    
    cli()


if __name__ == "__main__":
    main()

#!/usr/bin/env bash
#
# Shadow9 Manager - Main Control Script
# Manage users, start server, and test connections
#

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Load environment variables
if [ -f ".env" ]; then
    export $(grep -v '^#' .env | xargs)
fi

# Check if virtual environment exists
if [ ! -d "venv" ]; then
    echo -e "${RED}Error: Virtual environment not found.${NC}"
    echo "Please run ./setup first."
    exit 1
fi

# Activate virtual environment
source venv/bin/activate

# Custom test command
if [ "$1" = "test" ]; then
    shift
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║              Shadow9 Connection Test                          ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Get config from args or defaults
    HOST="${HOST:-127.0.0.1}"
    PORT="${PORT:-1080}"
    
    # Parse test arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --host)
                HOST="$2"
                shift 2
                ;;
            --port)
                PORT="$2"
                shift 2
                ;;
            --user)
                TEST_USER="$2"
                shift 2
                ;;
            --pass)
                TEST_PASS="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Prompt for credentials if not provided
    if [ -z "$TEST_USER" ]; then
        read -p "Username: " TEST_USER
    fi
    if [ -z "$TEST_PASS" ]; then
        read -s -p "Password: " TEST_PASS
        echo ""
    fi
    
    echo -e "\n${CYAN}Testing connection to $HOST:$PORT...${NC}\n"
    
    # Test using Python
    python -c "
import asyncio
import sys
sys.path.insert(0, 'src')

from shadow9.socks5_client import Socks5Client, ProxyConfig, Socks5ConnectionError, Socks5AuthError

async def test_connection():
    proxy = ProxyConfig(
        host='$HOST',
        port=$PORT,
        username='$TEST_USER',
        password='$TEST_PASS',
        timeout=10.0
    )
    
    client = Socks5Client(proxy)
    
    try:
        # Test connection to a known site
        print('  [1/3] Connecting to proxy...')
        await client.connect('httpbin.org', 80)
        print('  ✓ Proxy connection successful')
        
        print('  [2/3] Testing HTTP request...')
        request = b'GET /ip HTTP/1.1\r\nHost: httpbin.org\r\nConnection: close\r\n\r\n'
        await client.send(request)
        
        response = await client.recv(4096)
        print('  ✓ HTTP request successful')
        
        print('  [3/3] Parsing response...')
        response_text = response.decode('utf-8', errors='replace')
        
        # Extract IP from response
        if 'origin' in response_text:
            import json
            body_start = response_text.find('{')
            if body_start != -1:
                body = response_text[body_start:]
                try:
                    data = json.loads(body)
                    print(f'  ✓ Your exit IP: {data.get(\"origin\", \"Unknown\")}')
                except:
                    print('  ✓ Connection verified (could not parse IP)')
        else:
            print('  ✓ Connection verified')
        
        await client.close()
        
        print()
        print('═══════════════════════════════════════════════════════════════')
        print('                    ✓ ALL TESTS PASSED')
        print('═══════════════════════════════════════════════════════════════')
        return True
        
    except Socks5AuthError as e:
        print(f'  ✗ Authentication failed: {e}')
        print()
        print('  Check your username and password.')
        return False
    except Socks5ConnectionError as e:
        print(f'  ✗ Connection error: {e}')
        return False
    except ConnectionRefusedError:
        print(f'  ✗ Connection refused - is the server running?')
        print()
        print('  Start the server with: ./shadow9 serve')
        return False
    except Exception as e:
        print(f'  ✗ Error: {e}')
        return False

result = asyncio.run(test_connection())
sys.exit(0 if result else 1)
"
    exit $?
fi

# Show banner for certain commands
if [ "$1" = "serve" ] || [ "$1" = "" ]; then
    if [ "$1" = "" ]; then
        echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}║                   Shadow9 Manager                             ║${NC}"
        echo -e "${CYAN}║         Secure SOCKS5 Proxy with Tor Support                  ║${NC}"
        echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════╝${NC}"
        echo ""
    fi
fi

# Pass all arguments to the Python CLI
python -m shadow9 "$@"
